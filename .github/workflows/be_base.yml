name: be/base
on:
  workflow_call:
    inputs:
      runs-on:
        required: true
        type: string
defaults:
  run:
    working-directory: be
jobs:
  phpstan:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/be
      - run: >
          ./vendor/bin/phpstan analyse --error-format=checkstyle
          | tee >(cs2pr --notices-as-warnings --graceful-warnings --prepend-filename --prepend-source)
        # https://github.com/staabm/annotate-pull-request-from-checkstyle
        shell: bash

  psalm:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/be
      - run: >
          ./vendor/bin/psalm --output-format=checkstyle
          | tee >(cs2pr --notices-as-warnings --graceful-warnings --prepend-filename --prepend-source)
        shell: bash

  phpcs:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/be
      - id: run
        run: ./vendor/bin/phpcs --report-full --report-checkstyle=./phpcs-report.xml .
      - if: always() && steps.run.outcome == 'failure'
        run: cs2pr --notices-as-warnings --graceful-warnings --prepend-filename --prepend-source ./phpcs-report.xml

  pint:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/be
      - run: >
          ./vendor/bin/pint --test --format=checkstyle
          | tee >(cs2pr --notices-as-warnings --graceful-warnings --prepend-filename --prepend-source)
        shell: bash

  php-cs-fixer:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/be
      - run: >
          ./vendor/bin/php-cs-fixer fix --dry-run --format=checkstyle
          | tee >(cs2pr --notices-as-warnings --graceful-warnings --prepend-filename --prepend-source)
        shell: bash

  phpmd:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/be
      # https://github.com/phpmd/phpmd/issues/506
      - run: ./vendor/bin/phpmd . github cleancode,codesize,controversial,design,naming,unusedcode --exclude vendor
